<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Fast HTTP Vulnerability Scanner: C:/fscan/HTTPCore/HTTPCore.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<h1>C:/fscan/HTTPCore/HTTPCore.cpp</h1><a href="_h_t_t_p_core_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* TODO: </span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">* En la tabla de conexiones hacer referencia al hostname no solo al ipaddress, para evitar problemas con hosts que resuelven varias dns</span>
<a name="l00004"></a>00004 <span class="comment">****</span>
<a name="l00005"></a>00005 <span class="comment">El acceso a FreeRequest (para gestionar la estructura CONEXION) se realiza siempre bloqueando el mutex "LOCK".</span>
<a name="l00006"></a>00006 <span class="comment">Dado que FreeRequest() intenta reconectar, muchos threads pueden quedar bloqueados. </span>
<a name="l00007"></a>00007 <span class="comment">Revisar si el lock se debe realizar dentro de la propia funcion.</span>
<a name="l00008"></a>00008 <span class="comment">****</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">#include "IoFunctions.h"</span>
<a name="l00017"></a>00017 <span class="comment">#include "Threading.h"</span>
<a name="l00018"></a>00018 <span class="comment">#include "CallBack.h"</span>
<a name="l00019"></a>00019 <span class="comment">#include "Modules/Encoding_Chunked.h"</span>
<a name="l00020"></a>00020 <span class="comment">#ifdef _ZLIB_SUPPORT_</span>
<a name="l00021"></a>00021 <span class="comment">#include "Modules/Encoding_Deflate.h"</span>
<a name="l00022"></a>00022 <span class="comment">#endif</span>
<a name="l00023"></a>00023 <span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">#ifdef __WIN32__RELEASE__</span>
<a name="l00025"></a><a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">00025</a> <span class="comment">static HANDLE                   FreeConnectionHandle;</span>
<a name="l00026"></a>00026 <span class="comment">#else</span>
<a name="l00027"></a>00027 <span class="comment">static pthread_t FreeConnectionHandle;</span>
<a name="l00028"></a><a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">00028</a> <span class="comment">#endif</span>
<a name="l00029"></a><a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">00029</a> <span class="comment">static STABLISHED_CONNECTION *Connection_Table=NULL;</span>
<a name="l00030"></a><a class="code" href="_h_t_t_p_core_8cpp.html#f85b65e4294b653806183e1f01c2790f">00030</a> <span class="comment">static                                  CRITICAL_SECTION lock;</span>
<a name="l00031"></a>00031 <span class="comment">unsigned long                   PIPELINE_Request_ID;</span>
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">/*******************************************************************************************/</span>
<a name="l00036"></a>00036 
<a name="l00041"></a><a class="code" href="_h_t_t_p_core_8h.html#870830d9ee0b466b2287dca619c2a582">00041</a> <span class="comment">/*******************************************************************************************/</span>
<a name="l00042"></a>00042 <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8cpp.html#870830d9ee0b466b2287dca619c2a582" title="This function is used to clean the connection struct and cancel I/O request.">HTTPCoreCancelHTTPRequest</a>(<a class="code" href="_h_t_t_p_8h.html#22eca5cbcf622a90b3b81972f3718a90">HTTPHANDLE</a> HTTPHandle, <span class="keywordtype">int</span> what)
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044  <a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> phandle = (<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a>)HTTPHandle;
<a name="l00045"></a>00045  <span class="keywordtype">int</span> ret=0;
<a name="l00046"></a>00046  <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00047"></a>00047  <span class="keywordflow">if</span> (phandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>)
<a name="l00048"></a>00048  {
<a name="l00049"></a>00049          shutdown(phandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#5db9c0cf77db2e77f3990fe3227e1835">datasock</a>,2);
<a name="l00050"></a>00050          closesocket(phandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#5db9c0cf77db2e77f3990fe3227e1835">datasock</a>);
<a name="l00051"></a>00051          phandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#c569d7f7526b30844189101f5eeeab66">NumberOfRequests</a>=what;
<a name="l00052"></a>00052          ret=1;
<a name="l00053"></a>00053  }
<a name="l00054"></a>00054  <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00055"></a>00055  <span class="keywordflow">return</span> (ret);
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">/*******************************************************************************************/</span>
<a name="l00062"></a>00062 
<a name="l00067"></a><a class="code" href="_h_t_t_p_core_8h.html#310a818ceb8d6890e59a7a46437cdc45">00067</a> <span class="comment">/*******************************************************************************************/</span>
<a name="l00068"></a>00068 <span class="keywordtype">void</span> <a class="code" href="_h_t_t_p_core_8cpp.html#310a818ceb8d6890e59a7a46437cdc45" title="This function is used to clean the status of a connection struct when the conexion...">FreeConnection</a>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> *connection) {
<a name="l00069"></a>00069 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>        printf(<span class="stringliteral">"++++++++++++++++ FreeConnection( %i requests pending) +++++++++++\n"</span>,connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>);
<a name="l00071"></a>00071         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt; connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>; i++)
<a name="l00072"></a>00072         {
<a name="l00073"></a>00073                 printf(<span class="stringliteral">"REQUEST: %s\n"</span>,  connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>[i]-&gt;<a class="code" href="struct__data.html#19c5000cf9e76c06359103763fb0b29f">Header</a>);
<a name="l00074"></a>00074         }
<a name="l00075"></a>00075 <span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077         <a class="code" href="_h_t_t_p_core_8cpp.html#c7a53a7fe6480eed1d9ff971b48eae50" title="This function Adds a pending request struct to the connection pool.">RemovePipeLineRequest</a>(connection);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081         <span class="comment">/*</span>
<a name="l00082"></a>00082 <span class="comment">        for(int i=0;i&lt; connection-&gt;PENDING_PIPELINE_REQUESTS; i++)</span>
<a name="l00083"></a>00083 <span class="comment">        {</span>
<a name="l00084"></a>00084 <span class="comment">        printf("++++++++++++++++ FreeConnection( %i requests pending) +++++++++++\n",connection-&gt;PENDING_PIPELINE_REQUESTS);</span>
<a name="l00085"></a>00085 <span class="comment">        printf("REQUEST2: %s\n",  connection-&gt;PIPELINE_Request[i]-&gt;Header);</span>
<a name="l00086"></a>00086 <span class="comment">        }       */</span>
<a name="l00087"></a>00087 <span class="preprocessor">#endif</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a>00089         shutdown(connection-&gt;<a class="code" href="structconexiones.html#5db9c0cf77db2e77f3990fe3227e1835">datasock</a>,2);
<a name="l00090"></a>00090         closesocket(connection-&gt;<a class="code" href="structconexiones.html#5db9c0cf77db2e77f3990fe3227e1835">datasock</a>);
<a name="l00091"></a>00091         connection-&gt;<a class="code" href="structconexiones.html#c569d7f7526b30844189101f5eeeab66">NumberOfRequests</a>=0;
<a name="l00092"></a>00092         connection-&gt;<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>=0;
<a name="l00093"></a>00093 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>        connection-&gt;<a class="code" href="structconexiones.html#cf8fb031dc624a2a3d48ca3e2f5ca429">tlastused</a>.dwHighDateTime=0;
<a name="l00095"></a>00095         connection-&gt;<a class="code" href="structconexiones.html#cf8fb031dc624a2a3d48ca3e2f5ca429">tlastused</a>.dwLowDateTime=0;
<a name="l00096"></a>00096         <span class="comment">//if (connection-&gt;)</span>
<a name="l00097"></a>00097 <span class="preprocessor">#else</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>        connection-&gt;<a class="code" href="structconexiones.html#cf8fb031dc624a2a3d48ca3e2f5ca429">tlastused</a>=0;
<a name="l00099"></a>00099 <span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101         <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>) {
<a name="l00102"></a>00102 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>                printf(<span class="stringliteral">"LLAMANDO A STABLISH CONNECTION desde FreeConnection\n"</span>); 
<a name="l00104"></a>00104 <span class="preprocessor">#endif</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>                connection-&gt;<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>=1;
<a name="l00106"></a>00106                 <span class="keywordtype">int</span> i = <a class="code" href="_io_functions_8cpp.html#c5dc941f0db31e40b9c43fa6b07214c6" title="This function stablishes a connection against a remote host.">StablishConnection</a>(connection);
<a name="l00107"></a>00107                 <span class="keywordflow">if</span> (i) {
<a name="l00108"></a>00108                         <span class="keywordflow">for</span> (i = 0; i &lt; connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>; i++) {
<a name="l00109"></a>00109                                 <a class="code" href="_io_functions_8cpp.html#5bfb206cc97835337979f0d30b2a891a" title="This function sends an HTTP request to the remote webserver. a CONEXION struct with...">SendHTTPRequestData</a>(connection,connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>[i]);
<a name="l00110"></a>00110                         }
<a name="l00111"></a>00111                 } <span class="keywordflow">else</span> {
<a name="l00112"></a>00112                         <span class="comment">/* TODO 1 : Que pasa si no podemos reconectar... COMO SE GESTIONAN los errores... */</span>    
<a name="l00113"></a>00113                         printf(<span class="stringliteral">"ERROR UNABLE TO RECONNECT\n"</span>);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115                 }
<a name="l00116"></a>00116         } <span class="keywordflow">else</span> {
<a name="l00117"></a>00117                 connection-&gt;<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>;
<a name="l00118"></a>00118                 connection-&gt;<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>;
<a name="l00119"></a>00119                 connection-&gt;<a class="code" href="structconexiones.html#375a75e18df87f7002cb29e2728ee79b">NeedSSL</a>=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>;
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121         connection-&gt;<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>=0;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 <span class="comment">/*******************************************************************************************/</span>
<a name="l00125"></a>00125 
<a name="l00131"></a>00131 <span class="comment">/*******************************************************************************************/</span>
<a name="l00132"></a>00132 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="_h_t_t_p_core_8cpp.html#fe5e655689864b6d2e56305af320a800" title="This function analyzes and cleans the internal connection table every 5 seconds....">CleanConnectionTable</a>(<span class="keywordtype">void</span> *unused)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>        FILETIME fcurrenttime;
<a name="l00137"></a>00137         LARGE_INTEGER CurrentTime;
<a name="l00138"></a>00138         LARGE_INTEGER LastUsedTime;
<a name="l00139"></a>00139 <span class="preprocessor">#else</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>        time_t fcurrenttime;
<a name="l00141"></a>00141 <span class="preprocessor">#endif</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>        <span class="keywordflow">while</span>(1)
<a name="l00143"></a>00143         {
<a name="l00144"></a>00144 
<a name="l00145"></a>00145                 <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>                GetSystemTimeAsFileTime(&amp;fcurrenttime);
<a name="l00149"></a>00149                 CurrentTime.LowPart=fcurrenttime.dwLowDateTime;
<a name="l00150"></a>00150                 CurrentTime.HighPart=fcurrenttime.dwHighDateTime;
<a name="l00151"></a>00151 <span class="preprocessor">#else</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>                time(&amp;fcurrenttime);
<a name="l00153"></a>00153 <span class="preprocessor">#endif</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="_h_t_t_p_core_8h.html#888c7f2df3f09b8c920471f04815e18e">MAX_OPEN_CONNECTIONS</a>;i++)
<a name="l00155"></a>00155                 {
<a name="l00156"></a>00156                         <span class="keywordflow">if</span> ( (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].target!=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>) &amp;&amp; (!<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].io) &amp;&amp; (!<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].PENDING_PIPELINE_REQUESTS) )
<a name="l00157"></a>00157                         {
<a name="l00158"></a>00158                                 <span class="comment">//TODO: El recurso .io deberia estar protegido por el mutex de conexion[i].lock ?</span>
<a name="l00159"></a>00159 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span>                                LastUsedTime.HighPart= <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#cf8fb031dc624a2a3d48ca3e2f5ca429">tlastused</a>.dwHighDateTime;
<a name="l00161"></a>00161                                 LastUsedTime.LowPart= <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#cf8fb031dc624a2a3d48ca3e2f5ca429">tlastused</a>.dwLowDateTime;
<a name="l00162"></a>00162                                 <span class="keywordflow">if</span> ( (CurrentTime.QuadPart - LastUsedTime.QuadPart) &gt; <a class="code" href="_h_t_t_p_core_8h.html#4709905b4ab57d1baf948d9ab202a992">MAX_INACTIVE_CONNECTION</a> ) {
<a name="l00163"></a>00163 <span class="preprocessor">#else</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> ( (fcurrenttime -<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].tlastused)&gt; <a class="code" href="_h_t_t_p_core_8h.html#4709905b4ab57d1baf948d9ab202a992">MAX_INACTIVE_CONNECTION</a> )  {
<a name="l00165"></a>00165 <span class="preprocessor">#endif</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>
<a name="l00167"></a>00167 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>                                        printf(<span class="stringliteral">"DBG: Eliminando conexion %3.3i against %s:%i \n"</span>,i,<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].targetDNS,<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].port);
<a name="l00169"></a>00169 <span class="preprocessor">#endif</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>                                        <a class="code" href="_h_t_t_p_core_8cpp.html#310a818ceb8d6890e59a7a46437cdc45" title="This function is used to clean the status of a connection struct when the conexion...">FreeConnection</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i]);
<a name="l00171"></a>00171                                 }
<a name="l00172"></a>00172                         }
<a name="l00173"></a>00173                 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>                Sleep(5000);
<a name="l00179"></a>00179 <span class="preprocessor">#else</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>                sleep(5);
<a name="l00181"></a>00181 <span class="preprocessor">#endif</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>        }
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 <span class="preprocessor">#if 0</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="comment">/*******************************************************************************************/</span>
<a name="l00187"></a>00187 
<a name="l00192"></a>00192 <span class="comment">/*******************************************************************************************/</span>
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8h.html#4c682ee277fbde19c7b5f2412511028d">GetNumberOfConnectionsAgainstTarget</a>(<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> HTTPHandle)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195         <span class="keywordtype">int</span> n=0;
<a name="l00196"></a>00196         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;MAX_OPEN_CONNECTIONS;i++)
<a name="l00197"></a>00197         {
<a name="l00198"></a>00198                 <span class="keywordflow">if</span> ( (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].target==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#057c0e8eaba70410a2b1f89dc7266742">target</a>) &amp;&amp; (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#23974552947fa3fa7e1c64cc4e4af12a">port</a>) )
<a name="l00199"></a>00199                 {
<a name="l00200"></a>00200                         n++;
<a name="l00201"></a>00201                 }
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203         <span class="keywordflow">return</span>(n);
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 <span class="preprocessor">#endif</span>
<a name="l00206"></a><a class="code" href="_h_t_t_p_core_8cpp.html#505dd4f6d7af3a2463ce1702c247d24a">00206</a> <span class="preprocessor"></span><span class="comment">/*******************************************************************************************/</span>
<a name="l00208"></a>00208 
<a name="l00214"></a>00214 <span class="comment">/*******************************************************************************************/</span>
<a name="l00215"></a>00215 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8cpp.html#505dd4f6d7af3a2463ce1702c247d24a" title="This function checks the connection table searching for a free and inactive connection...">GetFirstIdleConnectionAgainstTarget</a>(<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> HTTPHandle)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;MAX_OPEN_CONNECTIONS;i++)
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219                 <span class="keywordflow">if</span> ( (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].ThreadID==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#ceb3db667f66937c9b11490eff919800">ThreadID</a>) &amp;&amp; (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#057c0e8eaba70410a2b1f89dc7266742">target</a>) &amp;&amp; (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#23974552947fa3fa7e1c64cc4e4af12a">port</a>) )
<a name="l00220"></a>00220                 {
<a name="l00221"></a>00221                         <span class="keywordflow">if</span> (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].io==0)
<a name="l00222"></a>00222                         {
<a name="l00223"></a>00223                                 <span class="keywordflow">return</span>(i);
<a name="l00224"></a>00224                         }
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227         <span class="keywordflow">return</span>(-1); <span class="comment">//Connection Not Found</span>
<a name="l00228"></a>00228 }
<a name="l00229"></a><a class="code" href="_h_t_t_p_core_8cpp.html#8be38410de4fccba4b89dbb6b19dddc1">00229</a> <span class="comment">/*******************************************************************************************/</span>
<a name="l00231"></a>00231 
<a name="l00237"></a>00237 <span class="comment">/*******************************************************************************************/</span>
<a name="l00238"></a>00238 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8cpp.html#8be38410de4fccba4b89dbb6b19dddc1" title="This function checks the connection table searching for the first unused connection...">GetFirstUnUsedConnectionAgainstTarget</a>(<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> HTTPHandle) 
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;MAX_OPEN_CONNECTIONS;i++)
<a name="l00241"></a>00241         {
<a name="l00242"></a>00242                 <span class="keywordflow">if</span> ( (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].target==<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>) &amp;&amp; (!<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].io) &amp;&amp; (!<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].PENDING_PIPELINE_REQUESTS) )
<a name="l00243"></a>00243                 {
<a name="l00244"></a>00244                         <span class="keywordflow">return</span>(i);
<a name="l00245"></a>00245                 }
<a name="l00246"></a>00246         }
<a name="l00247"></a><a class="code" href="_h_t_t_p_core_8h.html#c7a53a7fe6480eed1d9ff971b48eae50">00247</a>         <span class="keywordflow">return</span>(-1);
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 <span class="comment">/*******************************************************************************************/</span>
<a name="l00251"></a>00251 
<a name="l00255"></a>00255 <span class="comment">/*******************************************************************************************/</span>
<a name="l00256"></a>00256 <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8cpp.html#c7a53a7fe6480eed1d9ff971b48eae50" title="This function Adds a pending request struct to the connection pool.">RemovePipeLineRequest</a>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> *connection)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>) 
<a name="l00259"></a>00259         {
<a name="l00260"></a>00260                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a> -1;i++)
<a name="l00261"></a>00261                 {
<a name="l00262"></a>00262                         connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>[i]=connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>[i +1];
<a name="l00263"></a>00263                         connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[i]=connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[i+1];                
<a name="l00264"></a>00264                 }
<a name="l00265"></a>00265                 connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>--;
<a name="l00266"></a>00266                 connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>=(<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a>*)realloc(connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>,<span class="keyword">sizeof</span>(<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a>) * (connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>));
<a name="l00267"></a>00267                 connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>= (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) realloc(connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) * connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>);              
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> (!connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>)
<a name="l00269"></a>00269                 {
<a name="l00270"></a>00270                         connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>=NULL;
<a name="l00271"></a>00271                         connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a> = NULL;
<a name="l00272"></a>00272                         <span class="keywordflow">return</span>(0);
<a name="l00273"></a>00273                 } 
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         <span class="keywordflow">return</span>(connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 }
<a name="l00278"></a><a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072">00278</a> <span class="comment">/*******************************************************************************************/</span>
<a name="l00280"></a>00280 
<a name="l00286"></a>00286 <span class="comment">/*******************************************************************************************/</span>
<a name="l00287"></a>00287 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072" title="This function is the method for adding a new pending HTTP Request to the connection...">AddPipeLineRequest</a>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> *connection, <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> request)
<a name="l00288"></a>00288 {  
<a name="l00289"></a>00289 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>        printf(<span class="stringliteral">"*** AddPipeLineRequest: Añadiendo %i en conexion %i (%i +1)\n"</span>,<a class="code" href="_h_t_t_p_core_8cpp.html#f85b65e4294b653806183e1f01c2790f">PIPELINE_Request_ID</a>,connection-&gt;<a class="code" href="structconexiones.html#4af08b05f7825430910dbd05e70d56f2">id</a>,connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>);
<a name="l00291"></a>00291 <span class="preprocessor">#endif</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>        connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>=(<span class="keyword">struct </span><a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">_data</a> **)realloc(connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">_data</a> *) * (connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>+1));
<a name="l00293"></a>00293         connection-&gt;<a class="code" href="structconexiones.html#bea625e438b753e4f7e645af9db7f209">PIPELINE_Request</a>[connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>]=request;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>= (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) realloc(connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) * (connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>+1));  
<a name="l00296"></a>00296         connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a> ]=<a class="code" href="_h_t_t_p_core_8cpp.html#f85b65e4294b653806183e1f01c2790f">PIPELINE_Request_ID</a>++;
<a name="l00297"></a>00297         connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a>++;        
<a name="l00298"></a>00298         <span class="comment">//UnLockMutex(&amp;connection-&gt;lock);</span>
<a name="l00299"></a>00299         <span class="comment">/* TODO 1 : Revisar de donde sale ese unlockmutex- Es necesario? el acceso esta restringido con el mutex global LOCK */</span>
<a name="l00300"></a>00300         <span class="keywordflow">return</span>(connection-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[connection-&gt;<a class="code" href="structconexiones.html#700615aa660666fbb4ee7a10f8006c95">PENDING_PIPELINE_REQUESTS</a> -1]);
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="comment">/*******************************************************************************************/</span>
<a name="l00306"></a><a class="code" href="_h_t_t_p_core_8cpp.html#d70eaaa5f484bdfc0ec0be3d54d209c3">00306</a> 
<a name="l00314"></a>00314 <span class="comment">/*******************************************************************************************/</span>
<a name="l00315"></a>00315 <span class="keyword">static</span> <a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> *<a class="code" href="_h_t_t_p_core_8cpp.html#d70eaaa5f484bdfc0ec0be3d54d209c3" title="This function returns a CONEXION struct with initialized sockets. If the connection...">GetSocketConnection</a>(<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> HTTPHandle, <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> request, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *<span class="keywordtype">id</span>)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317         <span class="keywordtype">int</span> FirstEmptySlot=-1;
<a name="l00318"></a>00318         <span class="keywordtype">int</span> FirstIdleSlot=-1;
<a name="l00319"></a>00319         <span class="keywordtype">int</span> i=-1;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> * connection;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         <span class="comment">//TODO: Que hacemos con io ?</span>
<a name="l00325"></a>00325         <span class="comment">/*</span>
<a name="l00326"></a>00326 <span class="comment">        IO tiene sentido para señalar un socket que esta siendo utilizado para establecer la conexion ( connect) y sobre el que no se soportan mas operaciones de pipelining dado que no aun no esta en uso</span>
<a name="l00327"></a>00327 <span class="comment">        Debemos usarlo para evitar la reutilización de ese socket únicamente en ese momento :?</span>
<a name="l00328"></a>00328 <span class="comment"></span>
<a name="l00329"></a>00329 <span class="comment">        */</span>
<a name="l00330"></a>00330         <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00331"></a>00331         connection = HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <span class="comment">//Check if the Current handle is binded to a previously stablished connection</span>
<a name="l00336"></a>00336         <span class="keywordflow">if</span> ( request &amp;&amp; (connection) &amp;&amp;         (connection-&gt;<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#057c0e8eaba70410a2b1f89dc7266742">target</a>) &amp;&amp; (connection-&gt;<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#23974552947fa3fa7e1c64cc4e4af12a">port</a>) &amp;&amp; (connection-&gt;<a class="code" href="structconexiones.html#a255995dbf1b7f43be944aac3868de4f">ThreadID</a>==HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#ceb3db667f66937c9b11490eff919800">ThreadID</a>)  )
<a name="l00337"></a>00337         { 
<a name="l00338"></a>00338                 <span class="keywordflow">if</span>  (!HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a> )
<a name="l00339"></a>00339                 {
<a name="l00340"></a>00340 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>                        printf(<span class="stringliteral">"[DBG]: Direct Reuse Connection %3.3i- (%3.3i requests against %s)\n"</span>,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#4af08b05f7825430910dbd05e70d56f2">id</a>,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#c569d7f7526b30844189101f5eeeab66">NumberOfRequests</a>,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#c332280d1266f4cc5b35c8d76b3c38a5">targetDNS</a>);
<a name="l00342"></a>00342 <span class="preprocessor">#endif</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>                        *<span class="keywordtype">id</span>=<a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072" title="This function is the method for adding a new pending HTTP Request to the connection...">AddPipeLineRequest</a>(connection,request);
<a name="l00344"></a>00344                         <span class="comment">//UnLockMutex(&amp;lock);</span>
<a name="l00345"></a>00345                 } <span class="keywordflow">else</span> {
<a name="l00346"></a>00346                         <span class="keywordflow">while</span> (!HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>-&gt;<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>) {
<a name="l00347"></a>00347 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>                                printf(<span class="stringliteral">"[DBG]: Thread %i Waiting for io\n"</span>,*<span class="keywordtype">id</span>);
<a name="l00349"></a>00349 <span class="preprocessor">#endif</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>                                Sleep(500);
<a name="l00351"></a>00351                         }
<a name="l00352"></a>00352                         *<span class="keywordtype">id</span>=<a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072" title="This function is the method for adding a new pending HTTP Request to the connection...">AddPipeLineRequest</a>(connection,request);
<a name="l00353"></a>00353                 }
<a name="l00354"></a>00354                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);     
<a name="l00355"></a>00355                 <span class="keywordflow">return</span>(connection);
<a name="l00356"></a>00356         } 
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         <span class="comment">//Search For stablished connetions that are not currently used - TODO: Check if this is a good idea, maybe not</span>
<a name="l00359"></a>00359         FirstIdleSlot=<a class="code" href="_h_t_t_p_core_8cpp.html#505dd4f6d7af3a2463ce1702c247d24a" title="This function checks the connection table searching for a free and inactive connection...">GetFirstIdleConnectionAgainstTarget</a>(HTTPHandle);
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (FirstIdleSlot!=-1) <span class="comment">//Idle Connection Found. Reuse connection</span>
<a name="l00361"></a>00361         {
<a name="l00362"></a>00362 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>                printf(<span class="stringliteral">"[DBG]: Reuse Connection %3.3i  - %3.3i requests against %s\n"</span>,FirstIdleSlot,<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstIdleSlot].NumberOfRequests,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#c332280d1266f4cc5b35c8d76b3c38a5">targetDNS</a>);
<a name="l00364"></a>00364 <span class="preprocessor">#endif</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>                HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>=&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstIdleSlot];
<a name="l00366"></a>00366                 *<span class="keywordtype">id</span>=<a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072" title="This function is the method for adding a new pending HTTP Request to the connection...">AddPipeLineRequest</a>(HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>,request);
<a name="l00367"></a>00367                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00368"></a>00368                 <span class="keywordflow">return</span>(HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>);
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="comment">/*</span>
<a name="l00372"></a>00372 <span class="comment">        //No Unused Connections against designated target Found. Try to stablish a new connection</span>
<a name="l00373"></a>00373 <span class="comment">        i=GetNumberOfConnectionsAgainstTarget(HTTPHandle);</span>
<a name="l00374"></a>00374 <span class="comment">        if (i&gt;=MAX_OPEN_CONNETIONS_AGAINST_SAME_HOST) //Maximum Connection Limit Reached</span>
<a name="l00375"></a>00375 <span class="comment">        {</span>
<a name="l00376"></a>00376 <span class="comment">        #ifdef _DBG_</span>
<a name="l00377"></a>00377 <span class="comment">        //Unable to stablish another connection against that host. Connection limit reached.</span>
<a name="l00378"></a>00378 <span class="comment">        //Try increasing MAX_OPEN_CONNETIONS_AGAINST_SAME_HOST</span>
<a name="l00379"></a>00379 <span class="comment">        printf("[DBG]: Unable to stablish another connection against that host. Connection limit reached");</span>
<a name="l00380"></a>00380 <span class="comment">        #endif</span>
<a name="l00381"></a>00381 <span class="comment">        UnLockMutex(&amp;lock);</span>
<a name="l00382"></a>00382 <span class="comment">        return(NULL);</span>
<a name="l00383"></a>00383 <span class="comment">        }</span>
<a name="l00384"></a>00384 <span class="comment">        */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         FirstEmptySlot=<a class="code" href="_h_t_t_p_core_8cpp.html#8be38410de4fccba4b89dbb6b19dddc1" title="This function checks the connection table searching for the first unused connection...">GetFirstUnUsedConnectionAgainstTarget</a>(HTTPHandle);
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (FirstEmptySlot==-1) <span class="comment">//Connection table full. Try Again Later</span>
<a name="l00388"></a>00388         {
<a name="l00389"></a>00389                 <span class="comment">//Unable to get a free Socket connection against target. Maybe your application is too aggresive. Try increasing MAX_OPEN_CONNECTIONS</span>
<a name="l00390"></a>00390 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>                printf(<span class="stringliteral">"[DBG]: Unable to get a free Socket connection against target. Maybe your application is too aggresive"</span>);
<a name="l00392"></a>00392 <span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>                printf(<span class="stringliteral">"UNABLE TO GET FREE SOCKET!!!\n"</span>);               
<a name="l00394"></a>00394                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00395"></a>00395                 *<span class="keywordtype">id</span> = 0;
<a name="l00396"></a>00396                 <span class="keywordflow">return</span>(NULL);
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>=1;
<a name="l00400"></a>00400 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>        printf(<span class="stringliteral">"[DBG]: Using free slot %3.3i against %s:%i\n"</span>,FirstEmptySlot,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#c332280d1266f4cc5b35c8d76b3c38a5">targetDNS</a>,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#23974552947fa3fa7e1c64cc4e4af12a">port</a>);
<a name="l00402"></a>00402         printf(<span class="stringliteral">"Target: %i\n"</span>,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#057c0e8eaba70410a2b1f89dc7266742">target</a>);
<a name="l00403"></a>00403 <span class="preprocessor">#endif</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>        
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>=HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#057c0e8eaba70410a2b1f89dc7266742">target</a>;
<a name="l00407"></a>00407         strcpy(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].targetDNS,HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#c332280d1266f4cc5b35c8d76b3c38a5">targetDNS</a>);
<a name="l00408"></a>00408         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>=HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#23974552947fa3fa7e1c64cc4e4af12a">port</a>;
<a name="l00409"></a>00409         <span class="keywordflow">if</span> (HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#a5f34894ab8e6be2d9aaf11e09d6a4d8">ProxyHost</a>)
<a name="l00410"></a>00410         {
<a name="l00411"></a>00411                 <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>=atoi(HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#7da95263cf2f037327b6207e777e65b7">ProxyPort</a>);
<a name="l00412"></a>00412                 <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#c370c564fc92417530dbccd2f3ca7522">ConnectionAgainstProxy</a>=1;
<a name="l00413"></a>00413         } <span class="keywordflow">else</span> {
<a name="l00414"></a>00414                 <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#c370c564fc92417530dbccd2f3ca7522">ConnectionAgainstProxy</a>=0;
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#375a75e18df87f7002cb29e2728ee79b">NeedSSL</a>=HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#6d5bd82043ca7d728936ee49159fc8bb">NeedSSL</a>;
<a name="l00417"></a>00417         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#fa78936ecede3f022d11e2ff7e70fdce">BwLimit</a>=HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#19e4a97b2dd1411aeb68aac99d7346c4">DownloadBwLimit</a> ? atoi(HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#19e4a97b2dd1411aeb68aac99d7346c4">DownloadBwLimit</a>) : NULL;
<a name="l00418"></a>00418         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#a255995dbf1b7f43be944aac3868de4f">ThreadID</a> = HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#ceb3db667f66937c9b11490eff919800">ThreadID</a>;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>        printf(<span class="stringliteral">"CONEXION: Socket %i (%s:%i)\n"</span>,FirstEmptySlot,inet_ntoa(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].webserver.sin_addr),<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#d6aa6542253305beeab8b1cfa0c98f37">port</a>);
<a name="l00422"></a>00422         printf(<span class="stringliteral">"LLAMANDO A StablishConnection desde el GetSocketConnection\n"</span>);
<a name="l00423"></a>00423 <span class="preprocessor">#endif</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span>
<a name="l00425"></a>00425         <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         <span class="keywordflow">if</span> (!<a class="code" href="_io_functions_8cpp.html#c5dc941f0db31e40b9c43fa6b07214c6" title="This function stablishes a connection against a remote host.">StablishConnection</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot]))
<a name="l00428"></a>00428         {
<a name="l00429"></a>00429 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>                printf(<span class="stringliteral">"CONEXION FALLIDA\n"</span>);
<a name="l00431"></a>00431 <span class="preprocessor">#endif</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span>                <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00433"></a>00433                 <a class="code" href="_h_t_t_p_core_8cpp.html#310a818ceb8d6890e59a7a46437cdc45" title="This function is used to clean the status of a connection struct when the conexion...">FreeConnection</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot]);
<a name="l00434"></a>00434                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00435"></a>00435                 *<span class="keywordtype">id</span> = 0;
<a name="l00436"></a>00436                 <span class="keywordflow">return</span>(NULL);
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438         HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#15b531c396f5d064a4a8112feb01f6dc">conexion</a>=&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot];
<a name="l00439"></a>00439         <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00440"></a>00440         *<span class="keywordtype">id</span>=<a class="code" href="_h_t_t_p_core_8cpp.html#7e4dfcd1ce2182ec1e1bd21597861072" title="This function is the method for adding a new pending HTTP Request to the connection...">AddPipeLineRequest</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot],request);
<a name="l00441"></a>00441         <span class="comment">//SendHTTPRequestData(HTTPHandle-&gt;conexion, request);</span>
<a name="l00442"></a>00442         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot].<a class="code" href="structconexiones.html#f0e2c4b20db702ce3b516b19c6dbc3fa">io</a>=0;
<a name="l00443"></a>00443         <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00444"></a>00444         <span class="keywordflow">return</span>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[FirstEmptySlot]);<span class="comment">//&amp;conexion[FirstEmptySlot]);</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 <span class="comment">/*******************************************************************************************/</span>
<a name="l00448"></a>00448 <span class="comment">//   ******************            HTTP CORE FUNCTIONS            **********************</span>
<a name="l00449"></a>00449 <span class="comment">/*******************************************************************************************/</span>
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00454"></a>00454 
<a name="l00463"></a>00463 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00464"></a>00464 <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> <a class="code" href="_h_t_t_p_core_8cpp.html#cf1ce3329f1c2cbc026f6365358cd4d8">DispatchHTTPRequest</a>(<a class="code" href="struct__hhandle.html" title="This struct is the information used by FHScan to manage HTTP requests. This struct...">PHHANDLE</a> HTTPHandle,<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> request)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> response = NULL;
<a name="l00468"></a>00468         <a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a> *conexion;
<a name="l00469"></a>00469         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ret;
<a name="l00470"></a>00470         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> RequestID;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (request)
<a name="l00473"></a>00473         {
<a name="l00474"></a>00474                 <span class="comment">//ret = DoCallBack((!HTTPHandle-&gt;ProxyHost) ?  CBTYPE_CLIENT_REQUEST : CBTYPE_PROXY_REQUEST ,HTTPHandle,request,NULL);</span>
<a name="l00475"></a>00475                 ret = <a class="code" href="_call_back_8cpp.html#0ceac503cea1ad8a7a2e5f755c540343" title="CallBack Dispatcher. This function is called from the HTTPCore Module ( SendRawHttpRequest()...">DoCallBack</a>(<a class="code" href="_call_back_8h.html#5281fd39f6cf0481117df65c8a8c8913">CBTYPE_CLIENT_REQUEST</a> ,HTTPHandle,&amp;request,&amp;response);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                 <span class="keywordflow">if</span> (ret &amp; <a class="code" href="_call_back_8h.html#d450610df09cd5d5670241af7b8fc2c5">CBRET_STATUS_CANCEL_REQUEST</a>)
<a name="l00478"></a>00478                 {
<a name="l00479"></a>00479                         <span class="keywordflow">return</span>(response);
<a name="l00480"></a>00480                 }
<a name="l00481"></a>00481                 conexion=<a class="code" href="_h_t_t_p_core_8cpp.html#d70eaaa5f484bdfc0ec0be3d54d209c3" title="This function returns a CONEXION struct with initialized sockets. If the connection...">GetSocketConnection</a>(HTTPHandle,request,&amp;RequestID);
<a name="l00482"></a>00482                 <a class="code" href="_io_functions_8cpp.html#5bfb206cc97835337979f0d30b2a891a" title="This function sends an HTTP request to the remote webserver. a CONEXION struct with...">SendHTTPRequestData</a>(conexion,request);
<a name="l00483"></a>00483         } <span class="keywordflow">else</span> {
<a name="l00484"></a>00484                 conexion=<a class="code" href="_h_t_t_p_core_8cpp.html#d70eaaa5f484bdfc0ec0be3d54d209c3" title="This function returns a CONEXION struct with initialized sockets. If the connection...">GetSocketConnection</a>(HTTPHandle,request,&amp;RequestID);
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (!conexion) {
<a name="l00488"></a>00488                 <span class="keywordflow">return</span>(NULL);
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">while</span> (RequestID != conexion-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[0])
<a name="l00492"></a>00492         {
<a name="l00493"></a>00493 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span>                printf(<span class="stringliteral">"Waiting for ReadHTTPResponseData() %d / %d\n"</span>,RequestID,conexion-&gt;<a class="code" href="structconexiones.html#ca9fac8c5c32e99cbedcb07e5d2eff0e">PIPELINE_Request_ID</a>[0]);
<a name="l00495"></a>00495 <span class="preprocessor">#endif</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>                Sleep(100);
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498 <span class="preprocessor">#ifdef _DBG_</span>
<a name="l00499"></a>00499 <span class="preprocessor"></span>        printf(<span class="stringliteral">"LECTURA: LEYENDO PETICION %i en conexion %i\n"</span>,RequestID,conexion-&gt;<a class="code" href="structconexiones.html#4af08b05f7825430910dbd05e70d56f2">id</a>);
<a name="l00500"></a>00500 <span class="preprocessor">#endif</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>
<a name="l00502"></a>00502         response = <a class="code" href="_io_functions_8cpp.html#27fe71d4e4b885f403ffad1398cf1cfc" title="This function reads an HTTP response stream from the remote webserver.">ReadHTTPResponseData</a>(conexion,request,&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         ret = <a class="code" href="_call_back_8cpp.html#0ceac503cea1ad8a7a2e5f755c540343" title="CallBack Dispatcher. This function is called from the HTTPCore Module ( SendRawHttpRequest()...">DoCallBack</a>((!HTTPHandle-&gt;<a class="code" href="struct__hhandle.html#a5f34894ab8e6be2d9aaf11e09d6a4d8">ProxyHost</a>) ?  <a class="code" href="_call_back_8h.html#a6c9734782040f239773ab5c0bc00b35">CBTYPE_CLIENT_RESPONSE</a> : <a class="code" href="_call_back_8h.html#84572ab13cc6001058fc489b91bc7de4">CBTYPE_PROXY_RESPONSE</a>,HTTPHandle,&amp;request,&amp;response);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (ret &amp; CBRET_STATUS_CANCEL_REQUEST)
<a name="l00507"></a>00507         {
<a name="l00508"></a>00508                 <a class="code" href="_h_t_t_p_core_8cpp.html#6dbeec146e0ad13bf74132d33c7cecf8" title="This function deallocates the memory of an an HTTP_DATA struct.">FreeHTTPData</a>(response);
<a name="l00509"></a>00509                 <span class="keywordflow">return</span>(NULL);
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511         <span class="keywordflow">return</span>(response);
<a name="l00512"></a>00512 }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00516"></a>00516 
<a name="l00518"></a>00518 
<a name="l00524"></a>00524 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 <span class="keywordtype">int</span> <a class="code" href="_h_t_t_p_core_8cpp.html#44c204dea20abf9ba626eab1b1b22f2e" title="This function is used to start the HTTP Core Engine and must be called only once...">InitHTTPApiCore</a>(<span class="keywordtype">void</span>)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  i;
<a name="l00529"></a>00529 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>        <a class="code" href="base64_8h.html#a39b39d94407451a6ec0226479db68cf">DWORD</a> dwThread;
<a name="l00531"></a>00531         WSADATA ws;
<a name="l00532"></a>00532 <span class="preprocessor">#endif</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (!<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>)
<a name="l00535"></a>00535         {
<a name="l00536"></a>00536 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (WSAStartup( MAKEWORD(2,2), &amp;ws )!=0) {
<a name="l00538"></a>00538                         <span class="keywordflow">return</span>(0);
<a name="l00539"></a>00539                 }
<a name="l00540"></a>00540 <span class="preprocessor">#endif</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>                <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>=(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a>) * MAX_OPEN_CONNECTIONS);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                 <span class="keywordflow">for</span>(i=0;i&lt;MAX_OPEN_CONNECTIONS;i++) {
<a name="l00544"></a>00544                         memset(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i],<span class="charliteral">'\0'</span>,<span class="keyword">sizeof</span>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a>));
<a name="l00545"></a>00545                         <a class="code" href="_threading_8cpp.html#f5003e347eed6de00eae0f9d5b77baea" title="This function Initializes a mutex/critical Section object.">InitMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00546"></a>00546                         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>;
<a name="l00547"></a>00547                         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#4af08b05f7825430910dbd05e70d56f2">id</a>=i;
<a name="l00548"></a>00548                 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                 <a class="code" href="_threading_8cpp.html#f5003e347eed6de00eae0f9d5b77baea" title="This function Initializes a mutex/critical Section object.">InitMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00551"></a>00551 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>                <a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">FreeConnectionHandle</a>=CreateThread(NULL,0,(LPTHREAD_START_ROUTINE) <a class="code" href="_h_t_t_p_core_8cpp.html#fe5e655689864b6d2e56305af320a800" title="This function analyzes and cleans the internal connection table every 5 seconds....">CleanConnectionTable</a>, (LPVOID) i, 0, &amp;dwThread);
<a name="l00553"></a>00553 <span class="preprocessor">#else</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span>                <span class="comment">//pthread_create(&amp;e_th, NULL, CleanConnectionTable, (void *)i);</span>
<a name="l00555"></a>00555                 pthread_create(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">FreeConnectionHandle</a>, NULL, CleanConnectionTable, (<span class="keywordtype">void</span> *)i);
<a name="l00556"></a>00556 <span class="preprocessor">#endif</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>
<a name="l00558"></a>00558                 <span class="comment">//Load Defined CallBacks..</span>
<a name="l00559"></a>00559                 <a class="code" href="_call_back_8cpp.html#043c8ed64b23dae40dfa554e9c6a9045" title="This function Registers an HTTP Callback Handler and is called from external plugins...">RegisterHTTPCallBack</a>( <a class="code" href="_call_back_8h.html#a6c9734782040f239773ab5c0bc00b35">CBTYPE_CLIENT_RESPONSE</a> | <a class="code" href="_call_back_8h.html#84572ab13cc6001058fc489b91bc7de4">CBTYPE_PROXY_RESPONSE</a>, (<a class="code" href="_call_back_8h.html#4417d54c9ba42176fdeb1fe4a5c2f4ea">HTTP_IO_REQUEST_CALLBACK</a>)<a class="code" href="_encoding___chunked_8cpp.html#cdeb0b5d64fc93b8e0c29c6fcb9def9e" title="CallBack Function. This function is called from the DoCallBack() function once its...">CBDecodeChunk</a> );
<a name="l00560"></a>00560 <span class="preprocessor">#ifdef _ZLIB_SUPPORT_</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span>                <a class="code" href="_call_back_8cpp.html#043c8ed64b23dae40dfa554e9c6a9045" title="This function Registers an HTTP Callback Handler and is called from external plugins...">RegisterHTTPCallBack</a>( <a class="code" href="_call_back_8h.html#5281fd39f6cf0481117df65c8a8c8913">CBTYPE_CLIENT_REQUEST</a> | <a class="code" href="_call_back_8h.html#a6c9734782040f239773ab5c0bc00b35">CBTYPE_CLIENT_RESPONSE</a> , (<a class="code" href="_call_back_8h.html#4417d54c9ba42176fdeb1fe4a5c2f4ea">HTTP_IO_REQUEST_CALLBACK</a>)CBDeflate );
<a name="l00562"></a>00562 <span class="preprocessor">#endif</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span>
<a name="l00564"></a>00564 <span class="preprocessor">#ifdef _OPENSSL_SUPPORT_</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span>                SSL_load_error_strings();
<a name="l00566"></a>00566                 SSL_library_init();
<a name="l00567"></a>00567 <span class="preprocessor">#endif</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>
<a name="l00569"></a>00569                 <span class="comment">/*Pipelining.. */</span>
<a name="l00570"></a>00570                 <a class="code" href="_h_t_t_p_core_8cpp.html#f85b65e4294b653806183e1f01c2790f">PIPELINE_Request_ID</a> = 0;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                 <span class="comment">/* IO FILEMAPPING */</span>
<a name="l00573"></a>00573                 <a class="code" href="_io_functions_8cpp.html#2db99a3dd4f2a393adc384b437efaa30">InitFileMapping</a>();
<a name="l00574"></a>00574                 <span class="keywordflow">return</span>(1);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="keywordflow">return</span>(2); <span class="comment">//#define ERROR_ENGINE_ALREADY_INITIALIZED 2</span>
<a name="l00578"></a><a class="code" href="_h_t_t_p_core_8h.html#dcb6755722f6e41a75e641b81d9a831f">00578</a> 
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00581"></a>00581 
<a name="l00583"></a>00583 
<a name="l00587"></a>00587 <span class="comment">/***************************************************************************************************************/</span>
<a name="l00588"></a>00588 <span class="keywordtype">void</span> <a class="code" href="_h_t_t_p_core_8cpp.html#dcb6755722f6e41a75e641b81d9a831f" title="This function stops the HTTP Core Engine.">CloseHTTPApiCore</a>(<span class="keywordtype">void</span>) {
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00592"></a>00592 <span class="preprocessor">#ifdef __WIN32__RELEASE__</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dwExitCode=0;
<a name="l00594"></a>00594         TerminateThread(<a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">FreeConnectionHandle</a>,dwExitCode);
<a name="l00595"></a>00595         CloseHandle(<a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">FreeConnectionHandle</a>);
<a name="l00596"></a>00596         WSACleanup();
<a name="l00597"></a>00597 <span class="preprocessor">#else</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>        pthread_cancel(<a class="code" href="_h_t_t_p_core_8cpp.html#bcc51c9049722980d3dd3d053a1f50a0">FreeConnectionHandle</a>);
<a name="l00599"></a>00599 <span class="preprocessor">#endif</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>        <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;MAX_OPEN_CONNECTIONS;i++) {
<a name="l00601"></a>00601                 <a class="code" href="_threading_8cpp.html#446677ae8d0d0473635ed910af1f7f25" title="This function locks a mutex/critical Section object initialized by InitMutex().">LockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00602"></a>00602                 shutdown(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].datasock,2);
<a name="l00603"></a>00603                 <span class="keywordflow">if</span> (<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].target!=<a class="code" href="_h_t_t_p_core_8h.html#78796ff1132af738f94a9dbbe11e8883">TARGET_FREE</a>) {
<a name="l00604"></a>00604                         shutdown(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].datasock,2);
<a name="l00605"></a>00605                         closesocket(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].datasock);
<a name="l00606"></a>00606                 }
<a name="l00607"></a>00607                 <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].<a class="code" href="structconexiones.html#cc8b9c697e1299284a335ccd2de39996">target</a>=0;
<a name="l00608"></a>00608                 <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].lock);
<a name="l00609"></a>00609                 <a class="code" href="_threading_8cpp.html#2a34d813bf10bc4e874f5917a6000091" title="This function deletes a previously initialized mutex/critical Section object.">DeleteMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i].lock);
<a name="l00610"></a>00610                 memset(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>[i],0,<span class="keyword">sizeof</span>(<a class="code" href="structconexiones.html">STABLISHED_CONNECTION</a>));
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613         free(<a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>);
<a name="l00614"></a>00614         <a class="code" href="_h_t_t_p_core_8cpp.html#3dc2376b411e514b39b292cdad81b1e6">Connection_Table</a>=NULL;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         <a class="code" href="_io_functions_8cpp.html#cc1f7e0dd4cd2536ebf7e8ff81abca5c">EndFileMapping</a>();
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <a class="code" href="_threading_8cpp.html#a1db935fa6b7186629053cd0a2a90dc5" title="This function unlocks a mutex/critical Section object.">UnLockMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00620"></a>00620         <a class="code" href="_threading_8cpp.html#2a34d813bf10bc4e874f5917a6000091" title="This function deletes a previously initialized mutex/critical Section object.">DeleteMutex</a>(&amp;<a class="code" href="_h_t_t_p_core_8cpp.html#12dbcf00646e16fcb3fbc09e072746b0">lock</a>);
<a name="l00621"></a>00621         <a class="code" href="_call_back_8cpp.html#6c51a4c578433981b780ee63ce0b15f4" title="This function unregisters a previously loaded Callback.">RemoveHTTPCallBack</a>(<a class="code" href="_call_back_8h.html#72bd7a41d97de96cab9da959ade81c1a">CBTYPE_CALLBACK_ALL</a>,NULL);
<a name="l00622"></a><a class="code" href="_h_t_t_p_core_8h.html#da3419073817e6c8b87a8d9e19290b3e">00622</a> }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">/******************************************************************************/</span>
<a name="l00626"></a>00626 
<a name="l00632"></a>00632 <span class="comment">/*******************************************************************************/</span>
<a name="l00633"></a>00633 <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> <a class="code" href="_h_t_t_p_core_8cpp.html#da3419073817e6c8b87a8d9e19290b3e" title="This function Initializes an HTTP_DATA struct with the headers and and data sent...">InitHTTPData</a>(<span class="keywordtype">char</span> *header, <span class="keywordtype">char</span> *postdata)
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635         <a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a> data=(<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">PHTTP_DATA</a>)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">HTTP_DATA</a>));
<a name="l00636"></a>00636         <span class="keywordflow">if</span> (header)
<a name="l00637"></a>00637         {
<a name="l00638"></a>00638                 data-&gt;<a class="code" href="struct__data.html#19c5000cf9e76c06359103763fb0b29f">Header</a>=_strdup(header);
<a name="l00639"></a>00639                 data-&gt;<a class="code" href="struct__data.html#0363b50e0d70c990ca5c16ae3dffbf8e">HeaderSize</a>= (<span class="keywordtype">unsigned</span> int) strlen(header);
<a name="l00640"></a>00640         } <span class="keywordflow">else</span>
<a name="l00641"></a>00641         {
<a name="l00642"></a>00642                 data-&gt;<a class="code" href="struct__data.html#19c5000cf9e76c06359103763fb0b29f">Header</a>=_strdup(<span class="stringliteral">""</span>);
<a name="l00643"></a>00643                 data-&gt;<a class="code" href="struct__data.html#0363b50e0d70c990ca5c16ae3dffbf8e">HeaderSize</a>=0;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645         <span class="keywordflow">if</span> (postdata)
<a name="l00646"></a>00646         {
<a name="l00647"></a>00647                 data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>=_strdup(postdata);
<a name="l00648"></a>00648                 data-&gt;<a class="code" href="struct__data.html#e9905a5ab2a83104f9b02f49684d21aa">DataSize</a>=(<span class="keywordtype">unsigned</span> int) strlen(postdata);
<a name="l00649"></a>00649         } <span class="keywordflow">else</span>
<a name="l00650"></a>00650         {
<a name="l00651"></a>00651                 data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>=_strdup(<span class="stringliteral">""</span>);
<a name="l00652"></a><a class="code" href="_h_t_t_p_core_8h.html#6dbeec146e0ad13bf74132d33c7cecf8">00652</a>                 data-&gt;<a class="code" href="struct__data.html#e9905a5ab2a83104f9b02f49684d21aa">DataSize</a>=0;
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654         <span class="keywordflow">return</span>(data);
<a name="l00655"></a>00655 }
<a name="l00656"></a>00656 <span class="comment">/*******************************************************************************/</span>
<a name="l00658"></a>00658 
<a name="l00662"></a>00662 <span class="comment">/******************************************************************************/</span>
<a name="l00663"></a>00663 <span class="keywordtype">void</span> <a class="code" href="_h_t_t_p_core_8cpp.html#6dbeec146e0ad13bf74132d33c7cecf8" title="This function deallocates the memory of an an HTTP_DATA struct.">FreeHTTPData</a>(<a class="code" href="struct__data.html" title="This struct stores information to an HTTP request or response. Both HTTP Headers...">HTTP_DATA</a> *data)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (data)
<a name="l00666"></a>00666         {
<a name="l00667"></a>00667                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>) data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>=<a class="code" href="_io_functions_8cpp.html#4f0383e6479e5ab7a0e084bda6432798">DeleteFileMapping</a>(data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>);
<a name="l00668"></a>00668                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>) free(data-&gt;<a class="code" href="struct__data.html#373cc12509723ced245704979624aa20">Data</a>);
<a name="l00669"></a>00669                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct__data.html#19c5000cf9e76c06359103763fb0b29f">Header</a>) free(data-&gt;<a class="code" href="struct__data.html#19c5000cf9e76c06359103763fb0b29f">Header</a>);
<a name="l00670"></a>00670                 free(data);
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Sun Jan 18 00:32:04 2009 for Fast HTTP Vulnerability Scanner by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
